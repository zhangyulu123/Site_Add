<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv = "X-UA-Compatible" content = "IE = edge" charset = "UTF-8"/> 
		<title>SiteAdd</title>
		<link rel = "stylesheet" href = "../src/main/webapp/pages/css/wanma.css"/>
		<link rel = "stylesheet" href = "../src/main/webapp/tools/easyui/themes/default/easyui.css"/>
		<link rel = "stylesheet" href = "../src/main/webapp/tools/easyui/themes/icon.css"/>
		
		<script type = "text/javascript" src = "../src/main/webapp/tools/tssJS/tssJS.all.js"></script>
		
		<script type = "text/javascript" src = "../src/main/webapp/tools/easyui/jquery.min.js"></script>
		<script type = "text/javascript" src = "../src/main/webapp/tools/easyui/jquery.easyui.min.js"></script>
		<script type = "text/javascript" src = "../src/main/webapp/tools/easyui/easyui-lang-zh_CN.js"></script>
		
		<script type = "text/javascript" src = "../src/main/webapp/tools/echarts/echarts-3.1.5.js"></script>
		<script type = "text/javascript" src = "../src/main/webapp/more/bi_template/echart.js"></script>
		<script type = "text/javascript" src = "../src/main/webapp/more/bi_template/common.js"></script>
		<script type = "text/javascript" src = "../src/main/webapp/pages/js/common.js"></script>
		<script type = "text/javascript">
			var data;
			
			$(function(){
				
				var DATA_URL = "http://10.9.45.64:8080/tss/data/json/2212";
				var method = "POST", params = {"param1": "2016-5-13", "param2": "-1"};
				
				tssJS.ajax({
					url: DATA_URL,
					params: params,
					method: method,
					type: "json",
					waiting: true,
					ondata: function(){
						data =  this.getResponseJSON();
						//showtree(data);
						showCanvas1(data);
						//showCanvas2(data);
					}
				});
			});
				
			//完成率计算
			function rate_cal(add, target){
				if((target != 0) && (target != "null") && (add != "null")){
					return  Math.round(add/target*10000)/100 + "%"; //保留两位小数
				}else{
					return "";	
				}
			};
			
			//门店新增表明细、完成率明细
			function showtree(data){
				//分公司、分拨id构造，用于层级关系
				var orglist = [], centerlist = [], monthlist = [];
				var orgid = {}, centerid = {}, monthid = {}, center_to_org = {}; 
				var s = 1, t = 1;
				var json = {}, rows = [], footer = [];
				
				$.each(data, function(i, item){
					var org = item.org_name,  month = item.imonth;
					if(!orglist.contains(org)){
						orglist.push(org);
						orgid[org] = s;
						center_to_org[org] = {};
						s++;
					};
					
					//对日期定义id主要用于定义不同月份field名字
					if(!monthlist.contains(month)){  
						monthlist.push(month);
						monthid[month] = t;
						t++;
					}  
				});
		

					var len = (orglist.length).toString().length;
					
					$.each(data, function(i, item){
						var org = item.org_name, center = item.center;
						var pid = orgid[org], id = 0;
						if(!center_to_org.hasOwnProperty(org)){
							id = Math.pow(10, len)*pid+1;
							center_to_org[org] = {};
							center_to_org[org][center] = id;
						
						}else{
							if(!center_to_org[org].hasOwnProperty(center)){
								id = Object.getOwnPropertyNames(center_to_org[org]).length + 1;
								center_to_org[org][center] = id;
							};
						}
					})
					
				
				
				
					
				//基础数据按层级关系处理成json格式
				var obj = {};
				$.each(data, function(i, item){
					var templist = [];
					var month = item.imonth, org = item.org_name, center = item.center;
					var sites = item.sites, sites_a = item.sites_a, sites_t = item.sites_t,
					cbq = item.cbq, cbq_a = item.cbq_a, cbq_t = item.cbq_t, 
					stores = item.stores, stores_a = item.stores_a, stores_t = item.stores_t;
					if(!obj.hasOwnProperty(org)){
						obj[org] = {};
					};
					
					if(!obj[org].hasOwnProperty(center)){
						obj[org][center] = {};
					};
					obj[org][center][month] = {"site_c": sites - sites_a, "cbq_c": cbq - cbq_a, "store_c": stores - stores_a, "site_a": sites_a , "cbq_a": cbq_a, "store_a": stores_a, "site_t": sites_t, "cbq_t": cbq_t, "store_t": stores_t, "site_r": rate_cal(sites_a, sites_t), "cbq_r": rate_cal(cbq_a, cbq_t), "store_r": rate_cal(stores_a, stores_t)};
				});
				
			


				//动态添加列
				var row1 = [], row2 = [], row3 = [];
				for(var key in monthid){
					var month = key, id = monthid[key];
					row1.push("<th colspan = '9' align = 'center'>"+key+"</th>");
					row2.push("<th colspan = '3' align = 'center'>网点</th><th colspan = '3' align = 'center'>承包区</th><th colspan = '3' align = 'center'>门店</th>");
					row3.push("<th field = 'site_c'"+id+">月前数量</th><th field = 'site_a' "+id+">本月新增</th><th field = 'site_r'"+id+" >完成率</th><th field = 'cbq_c' "+id+">月前数量</th><th field = 'cbq_a' "+id+">本月新增</th><th field = 'cbq_r'"+id+">完成率</th><th field = 'store_c'"+id+" >月前数量</th><th field = 'store_a' "+id+">本月新增</th><th field = 'store_r' "+id+">完成率</th>");

				};
				row1.push("<th colspan = '9' align = 'center'>累计</th>");
				row2.push("<th colspan = '3' align = 'center'>网点</th><th colspan = '3' align = 'center'>承包区</th><th colspan = '3' align = 'center'>门店</th>");
				row3.push("<th field = 'site_c'>月前数量</th><th field = 'site_a'>本月新增</th><th field = 'site_r'>完成率</th><th field = 'cbq_c' >月前数量</th><th field = 'cbq_a' >本月新增</th><th field = 'cbq_r'>完成率</th><th field = 'store_c' >月前数量</th><th field = 'store_a'>本月新增</th><th field = 'store_r'>完成率</th>");
				
				$("#row1").innerHTML = row1.join("\n");
				$("#row2").innerHTML = row2.join("\n");
				$("#row3").innerHTML = row3.join("\n");
				
				
				//在rows中添加数据
				var rec = {}, rec1 = {}, cen = {}, all = {};
				
				all["site_a"] = 0;
				all["site_t"] = 0;
				all["cbq_a"] = 0;
				all["cbq_t"] = 0;
				all["store_a"] = 0;
				all["store_t"] = 0;
				for(var n in monthid){
					eval("all['site_a" + monthid[n] +"'] = 0");
					eval("all['cbq_a" + monthid[n] +"'] = 0");
					eval("all['store_a" + monthid[n] +"'] = 0");
					eval("all['site_t" + monthid[n] +"'] = 0");
					eval("all['cbq_t" + monthid[n] +"'] = 0");
					eval("all['store_t" + monthid[n] +"'] = 0");
					eval("all['site_c" + monthid[n] +"'] = 0");
					eval("all['cbq_c" + monthid[n] +"'] = 0");
					eval("all['store_c" + monthid[n] +"'] = 0");
				};
				
				for(var key1 in center_to_org){
					var len = Object.keys(center_to_org[key1]).length.toString().length;
					cen[key1] = {};
					for(var n in monthid){
							eval("cen[key1].site_c" + monthid[n] + "=0");
							eval("cen[key1].site_a" + monthid[n] + "=0");
							eval("cen[key1].site_t" + monthid[n] + "= 0");
							eval("cen[key1].cbq_c" + monthid[n] + "=0");
							eval("cen[key1].cbq_a" + monthid[n] + "=0");
							eval("cen[key1].cbq_t" + monthid[n] + "= 0");
							eval("cen[key1].store_c" + monthid[n] + "=0");
							eval("cen[key1].store_a" + monthid[n] + "=0");
							eval("cen[key1].store_t" + monthid[n] + "= 0");
					};
					
					for(var key2 in center_to_org[key1]){
						rec.id = orgid[key1]*Math.pow(10, len)+center_to_org[key1][key2];
						rec.name = key2;
						rec._parentId = orgid[key1];
						rec.site_a = 0, rec.cbq_a = 0, rec.store_a = 0, rec.site_t = 0, rec.cbq_t = 0, rec.store_t = 0;
						for(var month in obj[key1][key2]){
							eval("rec.site_c" + monthid[month] + "= obj[key1][key2]['"+month+"']['site_c']");
							eval("rec.site_a" + monthid[month] + "= obj[key1][key2]['"+month+"']['site_a']");
							eval("rec.site_r" + monthid[month] + "= obj[key1][key2]['"+month+"']['site_r']");
							eval("rec.cbq_c" + monthid[month] + "= obj[key1][key2]['"+month+"']['cbq_c']");
							eval("rec.cbq_a" + monthid[month] + "= obj[key1][key2]['"+month+"']['cbq_a']");
							eval("rec.cbq_r" + monthid[month] + "= obj[key1][key2]['"+month+"']['cbq_r']");
							eval("rec.store_c" + monthid[month] + "= obj[key1][key2]['"+month+"']['store_c']");
							eval("rec.store_a" + monthid[month] + "= obj[key1][key2]['"+month+"']['store_a']");	
							eval("rec.store_r" + monthid[month] + "= obj[key1][key2]['"+month+"']['store_r']");
							//横向累加
							rec.site_a += eval("obj[key1][key2]['"+month+"']['site_a']");
							rec.cbq_a += eval("obj[key1][key2]['"+month+"']['cbq_a']");
							rec.store_a += eval("obj[key1][key2]['"+month+"']['store_a']");
							rec.site_t += eval("obj[key1][key2]['"+month+"']['site_t']");
							rec.cbq_t += eval("obj[key1][key2]['"+month+"']['cbq_t']");
							rec.store_t += eval("obj[key1][key2]['"+month+"']['store_t']");
							//纵向累加
							
							eval("cen[key1].site_c" + monthid[month] + "+= rec.site_c" + monthid[month]);
							eval("cen[key1].site_a" + monthid[month] + "+= rec.site_a" + monthid[month]);
							eval("cen[key1].site_t" + monthid[month] + "+= obj[key1][key2]['"+month+"']['site_t']");
							eval("cen[key1].cbq_c" + monthid[month] + "+= rec.cbq_c" + monthid[month]);
							eval("cen[key1].cbq_a" + monthid[month] + "+= rec.cbq_a" + monthid[month]);
							eval("cen[key1].cbq_t" + monthid[month] + "+= obj[key1][key2]['"+month+"']['cbq_t']");
							eval("cen[key1].store_c" + monthid[month] + "+= rec.store_c" + monthid[month]);
							eval("cen[key1].store_a" + monthid[month] + "+= rec.store_a" + monthid[month]);
							eval("cen[key1].store_t" + monthid[month] + "+= obj[key1][key2]['"+month+"']['store_t']");
							
						};
						rec.site_r = rate_cal(rec.site_a, rec.site_t);
						rec.cbq_r = rate_cal(rec.cbq_a, rec.cbq_t);
						rec.store_r = rate_cal(rec.store_a, rec.store_t);
						
						//分公司累计完成率计算
						for(var str in cen[key1]){
							index = str.indexOf("_t");
							if(index != "-1"){
								var t = str.substring(0, index)+"_r"+str.substr(index+2);
								var a = str.substring(0, index)+"_a"+str.substr(index+2);
								eval("cen[key1]." + t + " = rate_cal(cen[key1]."+a+", cen[key1]."+str+")")
							};
						};
						rows.push(rec);
						rec = {};
					}
					
					rec1 = cen[key1];
					rec1.site_a = 0, rec1.cbq_a = 0, rec1.store_a = 0, rec1.site_t = 0, rec1.cbq_t = 0, rec1.store_t = 0;
					
					//横向累加
					for(var m in rec1){
						if(m.indexOf("site_a") != "-1"){
						rec1.site_a += cen[key1][m];
						}else if(m.indexOf("cbq_a") != "-1"){
							rec1.cbq_a += cen[key1][m];
						}else if(m.indexOf("store_a") != "-1"){
							rec1.store_a += cen[key1][m];
						}else if(m.indexOf("site_t") != "-1"){
							rec1.site_t += cen[key1][m]
						}else if(m.indexOf("cbq_t") != "-1"){
							rec1.cbq_t += cen[key1][m]
						}else if(m.indexOf("store_t") != "-1"){
							rec1.store_t += cen[key1][m]
						}
						
							
					}
					
					for(var n in rec1){
						if(n != "site_c" && n != "cbq_c" && n != "store_c" && n.indexOf("_r") == "-1"){
							all[n] += rec1[n];
						}	
					};
					
					rec1.id = orgid[key1];
					rec1.name = key1;
					
					rec1.site_r = rate_cal(rec1.site_a, rec1.site_t);
					rec1.cbq_r = rate_cal(rec1.cbq_a, rec1.cbq_t);
					rec1.store_r = rate_cal(rec1.store_a, rec1.store_t);
					rows.push(rec1);	
				
			};
			
			for(var str in all){
				index = str.indexOf("_t");
				if(index != "-1"){
					var t = str.substring(0, index)+"_r"+str.substr(index+2);
					var a = str.substring(0, index)+"_a"+str.substr(index+2);
					eval("all." + t + " = rate_cal(all."+a+", all."+str+")");
				};
			};

			footer.push(all);
			footer.name = "全网";
			json.rows = rows;
			json.footer = footer;
			
			$("#tree").treegrid({
				height: 500,
				treeField: "name",
				idField: "id",
				showFooter: true,
				data: json
			});
		
		};
	
		
		//数量统计	
		function showCanvas1(data){
			var dataObj = {};
			$.each(data, function(i, item){
				var month = item.imonth;
				if(!dataObj.hasOwnProperty(month)){
					dataObj[month] = {};
					dataObj[month]["site"] = 0;
					dataObj[month]["cbq"] = 0;
					dataObj[month]["store"] = 0;
				}else{
					dataObj[month]["site"] += item.sites;
					dataObj[month]["cbq"] += item.cbq;
					dataObj[month]["store"] += item.stores
				}
			});
			var axis = [], data_s = [], data_c = [], data_a = [];
			for(var m in dataObj){
				data_s.push(dataObj[m]["site"]);
				data_c.push(dataObj[m]["cbq"]);
				data_a.push(dataObj[m]["store"]);
				axis.push(m);
			};
			
			
			var myChart = echarts.init(document.getElementById("canvas"));
			var option = {
				xAxis: [{
					type: "category",
					data: axis
				}],
				yAxis: [{
					type: "value"
				}],
				tooltip: {
					trigger: "axis"
				},
				series: [{
					name: "门店",
					type: "line",
					data: data_s
				},{
					name: "承包区",
					type: "line",
					data: data_c
				},{
					name: "门店",
					type: "line",
					data: data_a
				}]
			}
			
			myChart.setOption(option);
			myChart.on("click", function(params){
				var month = params.name;
				var data_a = {};
				var data_s = [], data_c = [], axis = []; 
				$.each(data, function(i, item){
					if(item.imonth == month){
						if(!data_a.hasOwnProperty(item.org_name)){
							data_a[item.org_name]= {};
							data_a[item.org_name]["site"] = item.sites;
							data_a[item.org_name]["cbq"] = item.cbq;
						}else{
							data_a[item.org_name]["site"] += item.sites;
							data_a[item.org_name]["cbq"] += item.stores;
						}
					}
				});
				for(var n in data_a){
					data_s.push(data_a[n]["site"]);
					data_c.push(data_a[n]["cbq"]);
					axis.push(n)
				};
				
				myChart.setOption({
					xAxis: {
						data: axis
					},
					serirs: [{
						name: "网点",
						type: "bar",
						stack: "门店",
						data: data_s
					},{
						name: "承包区",
						type: "bar",
						stack: "门店",
						data: data_c
					}]
				});
				
				myChart.on("click", function(params){
					var org = params.name;
					var data_s = [], data_c = [], centerlist = []
					$.each(data, function(i, item){
						if(month == item.imonth && org == item.org_name){
							data_s.push(item.sites);
							data_c.push(item.cbq);
							centerlist.push(item.center);
						}
					});
					myChart.setOption({
						xAxis: [{
							data: centerlist
						}],
						series:[{
							name: "网点",
							type:"bar",
							stack:"门店",
							data: data_s
						},{
							name: "承包区",
							type: "bar",
							stack:"门店",
							data: data_c
						}]
					});
				});
			});
			
		};
		
		function showCanvas2(data){
			var dataObj = {};
			$.each(data, function(i, item){
				var month = item.imonth;
				if(!dataObj.hasOwnProperty(month)){
					dataObj[month] = {};
					dataObj[month]["site_a"] = 0;
					dataObj[month]["cbq_a"] = 0;
					dataObj[month]["store_a"] = 0;
					dataObj[month]["site_t"] = 0;
					dataObj[month]["cbq_t"] = 0;
					dataObj[month]["store_t"] = 0;
				}else{
					dataObj[month]["site_a"] += item.sites_a;
					dataObj[month]["cbq_a"] += item.cbq_a;
					dataObj[month]["store_a"] += item.stores_a;
					dataObj[month]["site_t"] = item.sites_t;
					dataObj[month]["cbq_t"] = item.cbq_t;
					dataObj[month]["store_t"] = item.stores_t;
				}
			});
			var data_s = [], data_c = [], data_a = [], axis = [];
			for(var n in dataObj){
				data_s.push(rate_cal(dataObj[n]["site_a"], dataObj[n]["site_t"]));
				data_c.push(rate_cal(dataObj[n]["cbq_a"], dataObj[n]["cbq_t"]));
				data_a.push(rate_cal(dataObj[n]["store_a"], dataObj[n]["store_t"]));
				axis.push(n)
			};
			
			var myChart = echarts.init(document.getElementById("canvas"));
			var option = {
				xAxis: [{
					type: "category",
					data: axis
				}],
				yAxis: [{
					type: "value"
				}],
				tooltip: {
					trigger: "axis"
				},
				series: [{
					name: "门店",
					type: "line",
					data: data_a
				},{
					name: "网点",
					type: "line",
					data: data_s
				},{
					name: "承包区",
					type: "line",
					data: data_c
				}]
			};
			myChart.setOption(option);
			myChart.on("click", function(params){
				var dataObj = {};
				var month = params.name;
				$.each(data, function(i, item){
					var org = item.org_name;
					if(month == item.imonth){
						if(!dataObj.hasOwnProperty(org)){
							dataObj[org] = {};
							dataObj[org]["site_a"] = 0;
							dataObj[org]["cbq_a"] = 0;
							dataObj[org]["store_a"] = 0;
							dataObj[org]["site_t"] = 0;
							dataObj[org]["cbq_t"] = 0;
							dataObj[org]["store_t"] = 0;
						}else{
							dataObj[org]["site_a"] += item.sites_a;
							dataObj[org]["cbq_a"] += item.cbq_a;
							dataObj[org]["store_a"] += item.stores_a;
							dataObj[org]["site_t"] = item.sites_t;
							dataObj[org]["cbq_t"] = item.cbq_t;
							dataObj[org]["store_t"] = item.stores_t;
						}
					}
				});
				var data_s = [], data_c = [], data_a = [], axis = []; 
				for(var n in dataObj){
					data_s.push(rate_cal(dataObj[n]["site_a"], dataObj[n]["site_t"]));
					data_c.push(rate_cal(dataObj[n]["cbq_a"], dataObj[n]["cbq_t"]));
					data_a.push(rate_cal(dataObj[n]["store_a"], dataObj[n]["store_t"]));
					axis.push(n);
				};
				myChart.setOption({
					xAxis: [{
						data: axis
					}],
					series: [{
						name: "网点",
						type: "bar",
						data:data_s
					},{
						name: "承包区",
						type: "bar",
						data: data_c
					},{
						name: "门店",
						type: "bar",
						data: data_a
					}]
				});
				myChart.on("click", function(param){
					var data_a = [], data_s = [], data_c = [], axis = [];
					$.each(data, function(i, item){
						if(month == item.imonth && params.name == item.org_name){
							data_s.push(rate_cal(item.sites_a, item.sites_t));
							data_c.push(rate_cal(item.cbq_a, item.cbq_t));
							data_a.push(rate_cal(item.stores_a, item.stores_t))
							axis.push(item.center);
						}
					});
					myChart.setOption({
						xAxis: [{
							data: axis
						}],
						serirs: [{
							name: "网点",
							type: "bar",
							data: data_s
						},{
							name: "承包区",
							type: "bar",
							data: data_c
						},{
							name: "门店",
							type: "bar",
							data: data_a
						}]
					});
				});
			});
		};
			
		</script>
	<head>
	<body>
		<div id = "wrapper">
				<div class = "easyui-layout" style = "width: 700px; height: 500px">
					<div id = "graph" data-options = "region: 'north', split: true" style = "height: 200px">
						<div id = 'toggle'>
							<select>
								<option value = '1'>数量统计</option>
								<option value = '2'>完成率统计</option>
							</select>
						</div>
						<div id = "canvas" style = "height: 100%"></div>
					</div>
					<div id = "tree" data-options = "region: 'center', split: true" style = "height: 100px">
						<table id = "rate" data-options = "fit: true">
							<thead>
									<tr id = "row1">
										<th field = 'name' rowspan = '3' width = "100px">名称</th>
									<!--	<th colspan = '9' align = 'center'>月份</th> -->
									</tr>
									
									<tr id = "row2">
									<!--	<th colspan = '3' align = 'center'>网点</th>
										<th colspan = '3' align = 'center'>承包区</th>
										<th colspan = '3' align = 'center'>门店</th> -->
									</tr>
									<tr id= "row3">
									<!--	<th field = 'site_c'>月前数量</th>
										<th field = 'site_a' >本月新增</th>
										<th field = 'site_r' >完成率</th>
										<th field = 'cbq_c' >月前数量</th>
										<th field = 'cbq_a' >本月新增</th>
										<th field = 'cbq_r'>完成率</th>
										<th field = 'store_c' >月前数量</th>
										<th field = 'store_a' >本月新增</th>
										<th field = 'store_r' >完成率</th> -->
									</tr>
							</thead>
						</table>
					</div>
				</div>
			</div>
		</div>
	</body>
</html>