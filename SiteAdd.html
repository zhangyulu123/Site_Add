<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv = "X-UA-Compatible" content = "IE = edge" charset = "UTF-8"/> 
		<title>SiteAdd</title>
		<!-- <link rel = "stylesheet" href = "../src/main/webapp/pages/css/wanma.css"/> -->
		<link rel = "stylesheet" href = "../src/main/webapp/tools/easyui/themes/default/easyui.css"/>
		<!-- <link rel = "stylesheet" href = "../src/main/webapp/tools/easyui/themes/icon.css"/> -->
		
		<script type = "text/javascript" src = "../src/main/webapp/tools/tssJS/tssJS.all.js"></script>
		
		<script type = "text/javascript" src = "../src/main/webapp/tools/easyui/jquery.min.js"></script>
		<script type = "text/javascript" src = "../src/main/webapp/tools/easyui/jquery.easyui.min.js"></script>
		<script type = "text/javascript" src = "../src/main/webapp/tools/easyui/easyui-lang-zh_CN.js"></script>
		
		<script type = "text/javascript" src = "../src/main/webapp/tools/echarts/echarts-3.1.5.js"></script>
		<!-- <script type = "text/javascript" src = "../src/main/webapp/more/bi_template/echart.js"></script> -->
		<!-- <script type = "text/javascript" src = "../src/main/webapp/more/bi_template/common.js"></script> -->
		<!-- <script type = "text/javascript" src = "../src/main/webapp/pages/js/common.js"></script> -->
		<script type = "text/javascript">
			var data;
			
			$(function(){
				
				var DATA_URL = "http://10.9.45.64:8080/tss/data/json/2212";
				var method = "POST", params = {"param1": "2016-5-13", "param2": "-1"};
				
				tssJS.ajax({
					url: DATA_URL,
					params: params,
					method: method,
					type: "json",
					waiting: true,
					ondata: function(){
						data =  this.getResponseJSON();
						//showtree(data);
						showCanvas1(data)
					}
				});
			});
			
			//门店新增表明细、完成率明细
			function showtree(data){
				//分公司、分拨id构造，用于层级关系
				var orglist = [], centerlist = [], monthlist = [];
				var orgid = {}, centerid = {}, monthid = {}, center_to_org = {}; 
				var s = 1, t = 1;
				var json = {}, rows = [], footer = [];
				
				$.each(data, function(i, item){
					var org = item.org_name,  month = item.imonth;
					if(!orglist.contains(org)){
						orglist.push(org);
						orgid[org] = s;
						center_to_org[org] = {};

						//rows.push({"id": s, "name": org});

						s++;
					};
					
					//对日期定义id主要用于定义不同月份field名字
					if(!monthlist.contains(month)){  //需要确定一下展示时间轴的问题
						monthlist.push(month);
						monthid[month] = t;
						t++;
					}  
				});
				
				$.each(data, function(i, item){
					var org = item.org_name, center = item.center;

					var max = 0, id = 0;
					
					if(!center_to_org[org][center]){
						id = Object.getOwnPropertyNames(center_to_org[org]).length + 1;
						center_to_org[org][center] = id;
						//eval("center_to_org['" + org + "']" + "." + center + "=" + id);
					}
					
				});
		

					var len = (orglist.length).toString().length;
					var max = 0, id = 0, pid = orgid[org];
					//var currentid = Object.getOwnPropertyNames(center_to_org[org]).length;
					if(center_to_org[org] == "undefined"){
						id = Math.pow(10, len)*pid+1;
						center_to_org[org] = {};
						center_to_org[org][center] = id;
						//eval("center_to_org['" + org + "']" + "." + center + "=" + id);
					}else{
						if(center_to_org[org][center] == "undefined"){
							id = Object.getOwnPropertyNames(center_to_org[org]).length + 1;
							center_to_org[org][center] = id;
						//eval("center_to_org['" + org + "']" + "." + center + "=" + id);
						};
				}
				});
				
				/*
					if(orglist.length == rows.length){
						//rows.push({"id":Math.pow(10, len)*pid+1, "_parentId": pid, "name": center});
						id = Math.pow(10, len)*pid+1;
						center_to_org[org] = {};
						eval("center_to_org['" + org + "']" + "." + center + "=" + id);
					}else{
						for(var i = 0; i < rows.length; i++){
							if(rows[i]["name"] == center){
								break;
							}else{
								if(rows[i]["_parentId"] == pid){
									if(parseInt(rows[i]["id"]) >= max){
									max = parseInt(rows[i]["id"]);
									}
								}
							}
						};
						if(i == rows.length){
							if(max == 0){
							rows.push({"id":Math.pow(10, len)*pid+1, "_parentId": pid, "name": center});
							center_to_org[org] = {};
							id = Math.pow(10, len)*pid+1;
							eval("center_to_org['" + org + "']" + "." + center + "=" + id);
							}else{
								rows.push({"id":max+1, "_parentId": pid, "name": center});
								max = max + 1;
								eval("center_to_org['" + org + "']" + "." + center + "=" + max);
								max = 0;
							};
						};
						
					};*/
					
				});
				
				/*
				$.each(data, function(i, item){
					var month = item.imonth, org = item.org_name, center = item.center;
					var pid = center_to_org[org][center];
					var len = Object.getOwnPropertyNames(center_to_org[org]).length.toString().length;
					var obj1 = {}, obj2 = {}, obj3 = {}
					rows.push({"id":Math.pow(10, len)*pid+1, "_parentId": pid, "name": "网点"});
					rows.push({"id":Math.pow(10, len)*pid+2, "_parentId": pid, "name": "承包区"});
					rows.push({"id":Math.pow(10, len)*pid+3, "_parentId": pid, "name": "门店"});
				});
				*/
				
					
				//基础数据按层级关系处理成json格式
				var obj = {};
				$.each(data, function(i, item){
					var templist = [];
					var month = item.imonth, org = item.org_name, center = item.center;
					var sites = item.sites, sites_a = item.sites_a, sites_t = item.sites_t,
					cbq = item.cbq, cbq_a = item.cbq_a, cbq_t = item.cbq_t, 
					stores = item.stores, stores_a = item.stores_a, stores_t = item.stores_t;
					if(!obj.hasOwnProperty(org)){
						obj[org] = {};
					};
					
					if(!obj[org].hasOwnProperty(center)){
						obj[org][center] = {};
					};
					obj[org][center][month] = {"site_c": sites , "cbq_c": cbq , "store_c": stores, "site_a": sites - sites_a , "cbq_a": cbq - cbq_a, "store_a": stores - stores_a, "site_t": sites_t, "cbq_t": cbq_t, "store_t": stores_t, "site_r": rate(sites_a, sites_t), "cbq_r": rate(cbq_a, cbq_t), "store_r": rate(stores_a, stores_t)};
				});
				
			


				//动态添加列
				var clist = [], alist = [];
				for(var key in monthid){
					var month = key, id = monthid[key];

					//var site = "site" + id, cbq = "cbq" + id, store = "store" + id;
					var cHtml = "<tr><th colspan = '9'>"+month+"</th></tr><tr><th colspan = '3'>网点</th><th colspan = '3'>承包区</th><th colspan = '3'>门店</th></tr><tr><th field = 'site_c" + id +"' width = '33'>月前数量</th><th field = 'site_a"+ id +"' width = '33'>本月新增</th><th field = 'site_r"+ id +"' width = '33'>完成率</th><th field = 'cbq_c" + id +"' width = '33'>月前数量</th><th field = 'cbq_a"+ id +"' width = '33'>本月新增</th><th field = 'cbq_r"+ id +"' width = '33'>完成率</th><th field = 'store_c" + id +"' width = '33'>月前数量</th><th field = 'store_a"+ id +"' width = '33'>本月新增</th><th field = 'store_r"+ id +"' width = '33'>完成率</th></tr>";
					//var aHtml = "<tr><th field = '" + add + "'>" + month + "</th></tr>";

					var amount = "amount" + id, add = "add" + id, rate = "rate" + id;
					var cHtml = "<tr><th colspan = '3'>"+month+"</th></tr><tr><th field = '" + amount +"'>月前数量</th><th field = '"+ add +"'>本月新增</th><th field = '"+ rate +"'>完成比</th></tr>";
					var aHtml = "<tr><th field = '" + add + "'>" + month + "</th></tr>";

					clist.push(cHtml);//完成率树列
					//alist.push(aHtml);//新增树列
				}
				/*
				for(var i = 0; i < monthid; i++){
					var month = monthlist[i];
					var amount = "amount" + i, add = "add" + i, rate = "rate" + i;
					var cHtml = "<tr><th colspan = '3'>"+month+"</th></tr><tr><th field = " + amount +">月前数量</th><th field = "+ add +">本月新增</th><th field = "+ rate +">完成比</th></tr>";
					var aHtml = "<tr><th field = " + add + ">" + month + "</th></tr>";
					clist.push(cHtml);//完成率树列
					alist.push(aHtml);//新增树列
				};*/
				clist.push("<tr><th colspan = '9'>累计</th></tr><tr><th colspan = '3'>网点</th><th colspan = '3'>承包区</th><th colspan = '3'>门店</th></tr><tr><th field = 'site_c' width = '33'>月前数量</th><th field = 'site_a' width = '33'>本月新增</th><th field = 'site_r' width = '33'>完成率</th><th field = 'cbq_c' width = '33'>月前数量</th><th field = 'cbq_a' width = '33'>本月新增</th><th field = 'cbq_r' width = '33'>完成率</th><th field = 'store_c' width = '33'>月前数量</th><th field = 'store_a' width = '33'>本月新增</th><th field = 'store_r' width = '33'>完成率</th></tr>");
				//alist.push("<tr><th field = 'add'>累计</th></tr>");
				
				$("#cCol").innerHTML = clist.join("\n");
				//$("#aCol").innerHTML = alist.join("\n");
				
				//在rows中添加数据

				var rec = {}, cen = {}, all = {};
				
				for(var n in monthid){
					eval("all['site_a" + monthid[n] +"'] = 0");
					eval("all['cbq_a" + monthid[n] +"'] = 0");
					eval("all['store_a" + monthid[n] +"'] = 0");
					eval("all['site_c" + monthid[n] +"'] = 0");
					eval("all['cbq_c" + monthid[n] +"'] = 0");
					eval("all['store_c" + monthid[n] +"'] = 0");
				};
				
				for(var key1 in center_to_org){
					var len = Object.keys(center_to_org[key1]).length.toString().length;
					cen[key1] = {};
					for(var key2 in center_to_org[key1]){
						rec.id = orgid[key1]*Math.pow(10, len)+center_to_org[key1][key2];
						rec.name = key2;
						rec._parentId = orgid[key1]
						rec.site_a = 0, rec.cbq_a = 0, rec_store_a = 0, rec.site_t = 0, rec.cbq_t = 0, rec.store_t = 0;
						for(var month in obj[key1][key2]){
							eval("rec.site_c" + monthid[month] + "= obj[key1][key2]['"+month+"']['site_c']");
							eval("rec.site_a" + monthid[month] + "= obj[key1][key2]['"+month+"']['site_a']");
							eval("rec.site_r" + monthid[month] + "= obj[key1][key2]['"+month+"']['site_r']");
							eval("rec.cbq_c" + monthid[month] + "= obj[key1][key2]['"+month+"']['cbq_c']");
							eval("rec.cbq_a" + monthid[month] + "= obj[key1][key2]['"+month+"']['cbq_a']");
							eval("rec.cbq_r" + monthid[month] + "= obj[key1][key2]['"+month+"']['cbq_r']");
							eval("rec.store_c" + monthid[month] + "= obj[key1][key2]['"+month+"']['store_c']");
							eval("rec.store_a" + monthid[month] + "= obj[key1][key2]['"+month+"']['store_a']");	
							eval("rec.store_r" + monthid[month] + "= obj[key1][key2]['"+month+"']['store_r']");
							//横向累加
							rec.site_a += eval("obj[key1][key2]['"+month+"']['site_a']");
							rec.cbq_a += eval("obj[key1][key2]['"+month+"']['cbq_a']");
							rec.store_a += eval("obj[key1][key2]['"+month+"']['store_a']");
							rec.site_t += eval("obj[key1][key2]['"+month+"']['site_t']");
							rec.cbq_t += eval("obj[key1][key2]['"+month+"']['cbq_t']");
							rec.store_t += eval("obj[key1][key2]['"+month+"']['store_t']");
							//纵向累加
							eval("cen[key1].site_c" + monthid[month] + "=0");
							eval("cen[key1].site_c" + monthid[month] + "+= rec.site_c" + monthid[month]);
							eval("cen[key1].site_a" + monthid[month] + "=0");
							eval("cen[key1].site_a" + monthid[month] + "+= rec.site_a" + monthid[month]);
							eval("cen[key1].cbq_c" + monthid[month] + "=0");
							eval("cen[key1].cbq_c" + monthid[month] + "+= rec.cbq_c" + monthid[month]);
							eval("cen[key1].cbq_a" + monthid[month] + "=0");
							eval("cen[key1].cbq_a" + monthid[month] + "+= rec.cbq_a" + monthid[month]);
							eval("cen[key1].store_c" + monthid[month] + "=0");
							eval("cen[key1].store_c" + monthid[month] + "+= rec.store_c" + monthid[month]);
							eval("cen[key1].store_a" + monthid[month] + "=0");
							eval("cen[key1].store_a" + monthid[month] + "+= rec.store_a" + monthid[month]);
						
						};
						rows.push(rec);
						rec = {};
					}
					rec = cen[key1];
					rec.id = orgid[key1];
					rec.name = key1;
					rec.site_a = 0, rec.cbq_a = 0, rec_store_a = 0, rec.site_c = 0, rec.cbq_c = 0, rec.store_c = 0;
					//横向累加
					for(var m in cen[key1]){
						if(m.indexOf("site_a") != "-1"){
							rec.site_a += cen[key1][m];
						}else if(m.indexOf("cbq_a") != "-1"){
							rec.cbq_a += cen[key1][m];
						}else if(m.indexOf("store_a") != "-1"){
							rec.store_a += cen[key1][m];
						}else if(m.indexOf("site_c") != "-1"){
							rec.site_c += cen[key1][m];
						}else if(m.indexOf("cbq_c") != "-1"){
							rec.cbq_c += cen[key1][m];
						}else if(m.indexOf("store_c") != "-1"){
							rec.store_c += cen[key1][m];
						}
							
					}
					
					rows.push(rec);
					for(var n in cen[key1]){
						if(n != "name" && n != "id"){
							all[n] += cen[key1][n];
						}
						
					}	

				for(var key1 in center_to_org){
					var len = Object.keys(center_to_org[key1]).length.toString().length;
					for(var key2 in center_to_org[key1]){
						var pid = center_to_org[key1][key2];
						
					}
				}
				
			};
		

			footer.push(all);
			footer.name = "全网";
			json.rows = rows;
			json.footer = footer;
			
			$("#tree").treegrid({
				width: 900,
				height: 500,
				treeField: "name",
				idField: "id",
				showFooter: true,
				data: json
			})
				
			};
			
		//完成率计算
		function rate(add, target){
			if(add == undefined || target == undefined || add == 0){
				return "";
			}else{
				return  Math.round(add/target*10000)/100 + "%"; //保留两位小数

			}
			
		//数量统计	
		function showCanvas1(data){
			var dataObj = {};
			$.each(data, function(i, item){
				var month = item.imonth;
				if(!dataObj.hasOwnProperty(month)){
					dataObj[month] = {};
					dataObj[month]["site"] = 0;
					dataObj[month]["cbq"] = 0;
					dataObj[month]["store"] = 0;
				}else{
					dataObj[month]["site"] += item.sites;
					dataObj[month]["cbq"] += item.cbq;
					dataObj[month]["store"] += item.stores
				}
			});
			var axis = [], data_s = [], data_c = [], data_a = [];
			for(var m in dataObj){
				data_s.push(dataObj[m]["site"]);
				data_c.push(dataObj[m]["cbq"]);
				data_a.push(dataObj[m]["store"]);
				axis.push(m);
			};
			series.push({name: "门店", type: "line", data:data_s});
			series.push({name: "网点", type: "line",  data:data_s});
			series.push({name: "承包区", type: "line", data: data_c});
			
			
			var myChart = echarts.init(document.getElementById("canvas"));
			var option = {
				xAxis: {
					type: "category",
					data: axis
				}],
				yAxis: [{
					type: "value"
				}],
				tooltip: {
					trigger: "axis"
				},
				series: series
			}
			
			myChart.setOption(option);
			myChart.on("click", function(params){
				var month = params.name;
				var data_a = {};
				var data_s = [], data_c = [], axis = []; 
				$.each(data, function(i, item)){
					if(item.imonth == month){
						if(!data.hasOwnProperty[item.org_name]){
							data_a[item.org_name]= {};
							data_a[item.org_name]["site"] = 0;
							data_a[item.org_name]["cbq"] = 0;
						}else{
							data_a[item.org_name]["site"] += item.sites;
							data_a[item.org_name]["cbq"] += item.stores;
						}
					}
				}
				for(var n in data_a){
					data_s.push(data_a[n]["site"]);
					data_c.push(data_a[n]["cbq"]);
					axis.push(n)
				};
				
				myCharts.setOption({
					xAxis: {
						data: axis
					},
					serirs: [{
						name: "网点",
						type: "bar",
						stack: "门店",
						data: data_s
					},{
						name: "承包区",
						type: "bar",
						stack："门店",
						data: data_c
					}]
				});
				
				myChart.on("click", function(params){
					var org = params.name;
					var data_s = [], data_c = [], centerlist = []
					$.each(data, function(i, item)){
						if(month == item.imonth && org == item.org_name){
							data_s.push(item.sites);
							data_c.push(item.cbq);
							centerlist.push(item.center);
						}
					};
					myChart.setOption({
						xAxis: {
							data: centerlist;
						},
						series:[{
							name: "网点",
							type："bar",
							stack："门店",
							data: data_s
						},{
							name: "承包区",
							type: "bar",
							stack："门店",
							data: data_c
						}]
					});
				});
			});
			
		};
		
		funtion showCanvas2(data){
			var dataObj = {};
			$.each(data, function(i, item){
				var month = item.imonth;
				if(!dataObj.hasOwnProperty(month)){
					dataObj[month] = {};
					dataObj[month]["site_a"] = 0;
					dataObj[month]["cbq_a"] = 0;
					dataObj[month]["store_a"] = 0;
					dataObj[month]["site_t"] = 0;
					dataObj[month]["cbq_t"] = 0;
					dataObj[month]["store_t"] = 0;
				}else{
					dataObj[month]["site_a"] += item.sites_a;
					dataObj[month]["cbq_a"] += item.cbq_a;
					dataObj[month]["store_a"] += item.stores_a;
					dataObj[month]["site_t"] = item.sites_t;
					dataObj[month]["cbq_t"] = item.cbq_t;
					dataObj[month]["store_t"] = item.stores_t;
				}
			});
			var data_s = [], data_c = [], data_a = [], axis = [];
			for(var n in dataObj){
				data_s.push(rate(dataObj[n]["site_a"], dataObj[n]["site_t"]));
				data_c.push(rate(dataObj[n]["cbq_a"], dataObj[n]["cbq_t"]));
				data_a.push(rate(dataObj[n]["store_a"], dataObj[n]["store_t"]));
				axis.push(n)
			};
			
			var myChart = echarts.init(document.getElementById("canvas"));
			var option = {
				xAxis: {
					type: "category",
					data: axis
				}],
				yAxis: [{
					type: "value"
				}],
				tooltip: {
					trigger: "axis"
				},
				series: [{
					name: "门店",
					type: "line",
					data: data_a
				},{
					name: "网点",
					type: "line",
					data: data_s
				},{
					name: "承包区",
					type: "line",
					data: data_c
				}]
			};
			myChart.setOption(option);
			myChart.on("click", function(params){
				
			})
		}
		
			

			
		</script>
	<head>
	<body>
		<div id = "wrapper">
			<div id = "tab" class = "easyui-tabs">
				<div id = "main" title = "门店新增完成情况">
					<div class = "easyui-layout" style = "width: 900px; height: 900px">
						<div id = "graph" data-options = "region: 'center'">
							<div id = 'toggle'>
								<select>
									<option value = '1'>数量统计</option>
									<option value = '2'>完成率统计</option>
								</select>
							</div>
							<div id = "canvas"></div>
						</div>
						<div id = "tree" data-options = "region: 'south'">
							<table id = "rate" data-options = "fit: true">
							<thead>
									<tr frozen = "true">
										<th field = "name">名称</th>
									</tr>
							</thead>
							<thead id = "cCol" style = "height: 500px">
							</thead>
							</table>
						</div>
					</div>
				</div>
				<div id = "grid" title = "门店新增数量明细">
					<table id = "detail">
						<thead>
							<tr frozen = "true">
								<th field = "name">名称</th>
							</tr>
						</thead>
						<thead id = "aCol">
							<tr></tr>
						</thead>
					</table>
				</div>
			</div>
		</div>
	</body>
</html>